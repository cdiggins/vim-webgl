<!-- 
    Copyright (c) 2021 VIMaec LLC 
    This code is licensed under MIT license 
    This is a demonstration of the VIM 3D Model viewer and VIM file loader built using Three.JS  
    For more information and the latest version see: http://www.github.com/vimaec/vim-webgl-viewer
-->
<html>
  <head>
    <link rel="stylesheet" ="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <style>
      
      /*Makes full screen and remove scrollbars*/
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: radial-gradient(circle at center, #d8d8e6, #8a8a8a);
      }
      html, 
      .ui-widget,
      table
      {
        font-family: 'Roboto', sans-serif;
        font-size: 12px;
      }
      #progress {
        width: fit-content;
        height: fit-content;
        padding: 10px;
        border: 1px solid #e3e3e3;
        border-radius: 3px;
        background-color: #f6f6f6;

        font-family: "Roboto", sans-serif;

        /*Centers the box*/
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }           
    </style>
    <title>VIM 3D Model Viewer</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <script src="https://unpkg.com/three@0.133.1/build/three.min.js"></script> 
    <script src="../dist/vim-webgl-viewer.iife.js"></script>
    <!-- <script src="https://unpkg.com/vim-webgl-viewer@1.2.7"></script> -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>    
    <script>
     
  </script>
</head>
  <body>
    <script>
      function parameterRowDiv(name, value) {
        const pos = name.indexOf(":");
        if (pos > 0) name = name.substring(pos);
        return `<tr><td>${name}</td><td>${value}</td></tr>`
      }        

      // Parse URL
      const params = new URLSearchParams(window.location.search)
      const url = params.has('vim')
        ? params.get('vim')
        //: './mep-compressed.vim';
        : 'https://vim.azureedge.net/samples/mep-gzip.vim';
        //: 'https://vim.azureedge.net/samples/residence.vim'

      let transparency = 'all'
      if (params.has('transparency')) {
        const t = params.get('transparency')
        transparency = geometry.transparencyIsValid(t) ? t : 'all'
      }

      // Create Viewer
      const viewer = new VIM.Viewer({
        groundPlane: {
          show: true,
          texture:
            'https://vimdevelopment01storage.blob.core.windows.net/textures/vim-floor-soft.png',
          opacity: 1,
          size: 5,
        },
      })

    function updateProgress(show, amount) {      
      if (!show) {
        $("#progress").hide();
      }
      else {
        $("#progress").show().text(amount);        
      } 
    }
      
    function loadFromUrl(url) 
    {
      updateProgress(true, `Loading`);

      const xhr = new XMLHttpRequest();
      xhr.open('GET', url)
      xhr.responseType = 'arraybuffer'

      xhr.onprogress = (prog) => {
        updateProgress(true, `${Math.trunc(prog.loaded / 1000 / 1000)} MB`);
      }
      
      xhr.onload = () => {
        updateProgress(true, "Loaded");
        loadFromBuffer(xhr.response);
        updateProgress(false);
      }
      
      xhr.onerror = (err) => {
        updateProgress(true, "Loaded");
      }

      xhr.send();
    }

    // Load function arrayBuffer
    function loadFromBuffer(vim) {
      viewer.loadVim(
        vim,
        {
          rotation: { x: 270, y: 0, z: 0 },
          transparency: transparency,
        }
      )
    }

    // Add load file button
    const input = document.createElement('input')
    input.type = 'file'
    document.body.prepend(input)

    input.onchange = (e) => {
      viewer.clear()
      // getting a hold of the file reference
      const file = e.target.files[0]

      // setting up the reader
      const reader = new FileReader()
      reader.readAsArrayBuffer(file)

      // Load vim once file is read.
      reader.onload = (readerEvent) => {
        loadFromBuffer(readerEvent.target.result)
      }
    }

    const defaultClick = viewer.onMouseClick.bind(viewer);
    
    function updateParameterDialog(hit)
    {
      const vim = viewer.vims[0];
      if (!vim || !hit || !hit.object) 
      {
        return; 
      }
      const elementIndex = hit.object.element;
      const entity = vim.document.getRowData('Vim.Element', elementIndex);

      html = '<table><th>Name</th><th>Value</th>'
      for (const k in entity) {
        html += parameterRowDiv(k, entity[k])
      }
      html += "</table>"
      $( "#parameter-table" ).html(html)
    }

    function updateSelection(hit) 
    {
      const vim = viewer.vims[0];
      if (!vim || !hit) {
        viewer.selection.select(null);
        return; 
      }
      viewer.selection.select(hit.object);
    }

    function onClick(hit) 
    {
      updateSelection(hit);

      // Open the dialog if we hit something
      if (hit && hit.object) {
        $( function() {
          $( "#dialog" ).dialog();
        } ); 
      }

      updateParameterDialog(hit);
    }

    viewer.onMouseClick = onClick;

    function debounce(callback, wait) {
        var timeout;
        return function(e) {
          clearTimeout(timeout);

          timeout = setTimeout(() => {
            callback(e);
          }, wait);
        }
      }

      function throttle(callback, wait) {
        var timeout
        return function(e) {
          if (timeout) return;
          timeout = setTimeout(() => (callback(e), timeout=undefined), wait)
        }
      }


    function mouseMove(event) {
        const pos = new THREE.Vector2(event.offsetX, event.offsetY);
        const result = viewer.inputs._mouse._raycaster.screenRaycast(pos);        
        updateParameterDialog(result);
      }

    viewer.viewport.canvas.addEventListener('mousemove', throttle(mouseMove, 200));

    // load default model
    loadFromUrl(url)

    $("#progress").hide();

    globalThis.viewer = viewer
    </script>
    <div id="dialog" title="VIM Data" style="display: none">
      <div id="parameter-table">
      </div>  
    </div>
    <div id="progress">
    </div>
  </body>
</html>
